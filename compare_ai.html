<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Comparison</title>
    <style>
        .image-container {
            position: relative;
            margin-bottom: 10px;
            display: inline-block;
        }
        .delete-post {
            position: absolute;
            top: 0;
            right: 0;
            background-color: red;
            color: white;
            padding: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            display: none;
        }
        .image-container:hover .delete-post {
            display: block;
        }
    </style>

<script src="compare_ai.js"></script>
</head>
<body>
    <h1>Image Comparison</h1>
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="uploadAndFindSimilarPets()">Find Similar Pets</button>

    <button onclick="uploadAndPostImage()">Post</button>

    <div id="uploadedImagesContainer">
        <!-- Container for uploaded images -->
    </div>

    <div id="result" style="display: none;">
        <h2>Comparison Result</h2>
        <ul id="resultList"></ul>
        
    </div>

    <div id="similarPetsContainer">
        <!-- Container for similar pet images -->
    </div>

    <script>

// Corrected function to handle both upload and finding similar pets
async function uploadAndFindSimilarPets() {
    const input = document.getElementById('imageInput');
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('image', file);

    // Step 1: Upload the image to '/upload' endpoint
    const uploadResponse = await fetch('/upload', {
        method: 'POST',
        body: formData
    });

    if (uploadResponse.ok) {
        const { image_id } = await uploadResponse.json(); // Assuming JSON response with an image_id
        // Step 2: Use the image_id to find similar pets on '/find_similar_pets' endpoint
        // (This part requires adjusting based on the correct implementation as suggested in previous interactions)
        findSimilarPets(image_id);
    } else {
        console.error('Upload Error:', await uploadResponse.text());
    }
}

// Adjusted findSimilarPets to use imageId for fetching similar pets
// Note: This necessitates backend changes to receive and process the image_id instead of the direct image file.
async function findSimilarPets(imageId) {
    const response = await fetch('/find_similar_pets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image_id: imageId })
    });

    if (response.ok) {
        const similarPets = await response.json();
        displaySimilarPets(similarPets);
    } else {
        console.error('Error finding similar pets:', response.statusText);
    }
}




        // Function to display the similar pet images
        function displaySimilarPets(similarPets) {
            // Sort the similar pets based on their similarity score or relevant metric
            similarPets.sort((a, b) => b.similarityScore - a.similarityScore);

            const similarPetsContainer = document.getElementById('similarPetsContainer');
            similarPetsContainer.innerHTML = '';

            similarPets.forEach(pet => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('image-container');

                const img = new Image();
                img.src = pet.image_url; // Assuming the server returns the image URL for similar pets
                img.alt = 'Similar Pet Image';

                const petInfo = document.createElement('div');
                petInfo.innerHTML = `
                    <h3>${pet.name}</h3>
                    <p>Breed: ${pet.breed}</p>
                    <p>Color: ${pet.color}</p>
                    <p>Age: ${pet.age}</p>
                    <!-- Add more pet information here -->
                `;

                imgContainer.appendChild(img);
                imgContainer.appendChild(petInfo);
                similarPetsContainer.appendChild(imgContainer);
            });
        }

        // Function to find similar pets
        async function findSimilarPets() {
            const input = document.getElementById('imageInput');
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch('/find_similar_pets', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const similarPets = await response.json();
                displaySimilarPets(similarPets);
            } else {
                console.error('Error:', response.statusText);
            }
        }

        // Function to store image data in local storage
        function storeImageData(imageData) {
            const uploadedImages = JSON.parse(localStorage.getItem('uploadedImages')) || [];
            uploadedImages.push(imageData);
            localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
        }

        // Function to retrieve image data from local storage
        function retrieveImageData() {
            return JSON.parse(localStorage.getItem('uploadedImages')) || [];
        }

        // Function to display the uploaded images
        function displayUploadedImages() {
            const uploadedImagesContainer = document.getElementById('uploadedImagesContainer');
            uploadedImagesContainer.innerHTML = '';
            const uploadedImages = retrieveImageData();
            uploadedImages.forEach(imageData => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('image-container');

                const img = new Image();
                img.src = imageData;
                img.alt = 'Uploaded Image';

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete Post';
                deleteButton.classList.add('delete-post');
                deleteButton.onclick = () => deleteImage(imageData);

                imgContainer.appendChild(img);
                imgContainer.appendChild(deleteButton);
                uploadedImagesContainer.appendChild(imgContainer);
            });
        }

        // Function to delete an uploaded image
        function deleteImage(imageData) {
            const uploadedImages = retrieveImageData().filter(img => img !== imageData);
            localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
            displayUploadedImages();
        }


        async function uploadAndPostImage() {
    const input = document.getElementById('imageInput');
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('image', file);

    // Upload the image
    const uploadResponse = await fetch('/upload', {
        method: 'POST',
        body: formData
    });

    if (uploadResponse.ok) {
        console.log('Image uploaded successfully');
        const imageId = await uploadResponse.text(); // Assuming the image ID is returned as plain text
        findSimilarPets(imageId); // Assuming you modify findSimilarPets to take an imageId
    } else {
        console.error('Upload Error:', uploadResponse.statusText);
    }
}



        async function uploadAndPostImage() {
            const input = document.getElementById('imageInput');
            const file = input.files[0];
            if (!file) return;

            // Display the uploaded image
            const imageUrl = URL.createObjectURL(file);
            storeImageData(imageUrl);
            displayUploadedImages();

            // Send the image to the backend for processing
            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                console.log('Image uploaded successfully');
                // No need to compare images here, as we are not displaying comparison result on the same page
            } else {
                console.error('Error:', response.statusText);
            }
        }

        // Check if there are uploaded images in local storage and display them
        window.onload = function() {
            displayUploadedImages();
        };


    </script>
        <script src="compare_ai.js"></script>

</body>
</html>
